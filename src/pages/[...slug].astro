---
import { getCollection, render } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import EpisodeSidebar from "@/components/EpisodeSidebar.astro";
import TableOfContents from "../components/TableOfContents.astro";
import AudioPlayer from "@/components/AudioPlayer.astro";
import Footer from "@/components/Footer.astro";
import Subscribe from "@/components/Subscribe.astro";

export async function getStaticPaths() {
  const podcastEntries = await getCollection("podcast");

  // Sort episodes same as Main.astro/EpisodeSidebar.astro
  const sortedEntries = [...podcastEntries].sort((a, b) => {
    const aSeason = a.data.season || 0;
    const bSeason = b.data.season || 0;
    if (bSeason !== aSeason) {
      return bSeason - aSeason;
    }
    return b.data.sidebar.order - a.data.sidebar.order;
  });

  // Compute episode numbers (last in sorted list = #1)
  const episodeNumbers = new Map(
    sortedEntries.map((entry, index) => {
      const slug = entry.id.split("/").pop() || "";
      return [slug, sortedEntries.length - index];
    })
  );

  // Pre-render content at build time
  const pages = await Promise.all(
    podcastEntries.map(async (entry) => {
      const slug = entry.id.split("/").pop();
      const { Content, headings } = await render(entry);
      const h4Headings = headings.filter((h) => h.depth === 4);

      return {
        params: { slug },
        props: {
          slug,
          Content,
          headings: h4Headings,
          frontmatter: entry.data,
          episodeNumber: episodeNumbers.get(slug || "") || 0,
        },
      };
    }),
  );

  return pages;
}

const { slug, Content, headings, frontmatter, episodeNumber } = Astro.props;
---

<Layout frontmatter={frontmatter} slug={`/${slug}`}>
  <EpisodeSidebar currentSlug={slug} headings={headings} />

  <div class="lg:ml-80">
    <div class="mx-auto px-4 py-8 flex flex-col lg:max-w-4xl">
      {/* Episode header */}
    <header class="text-center mb-6">
      <h1 class="text-2xl md:text-3xl font-semibold mb-3">{frontmatter.title}</h1>
      <div class="flex items-center justify-center gap-3 text-sm text-his-text-secondary">
        <time datetime={frontmatter.date.toISOString()}>
          {frontmatter.date.toLocaleDateString("en-US", {
            year: "numeric",
            month: "short",
            day: "numeric",
          })}
        </time>
        {frontmatter.time && (
          <>
            <span class="text-his-text-tertiary">•</span>
            <span>{frontmatter.time} min</span>
          </>
        )}
        {episodeNumber > 0 && (
          <>
            <span class="text-his-text-tertiary">•</span>
            <span class="text-his-green/80">#{episodeNumber}</span>
          </>
        )}
      </div>
    </header>

    <Subscribe />
    <TableOfContents headings={headings} />

    <div class="mx-auto max-w-3xl">
      <main>
        <blockquote class="text-sm leading-relaxed text-his-text-secondary max-w-xl mx-auto mb-8">
          {frontmatter.description}
        </blockquote>
        <Content />
      </main>
    </div>
    <Footer />
    <AudioPlayer title={frontmatter.title} src={frontmatter.episodeLink} />
    </div>
  </div>
</Layout>
