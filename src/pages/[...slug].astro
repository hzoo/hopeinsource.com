---
import { getCollection, render } from "astro:content";
import EpLayout from "../layouts/EpLayout.astro";
import TableOfContents from "../components/TableOfContents.astro";
import { hisMetadata } from "@/metadata.ts";
import AudioPlayer from "@/components/AudioPlayer.astro";
import Footer from "@/components/Footer.astro";
import Subscribe from "@/components/Subscribe.astro";

export async function getStaticPaths() {
  const podcastEntries = await getCollection("podcast");

  // Pre-render content at build time
  const pages = await Promise.all(
    podcastEntries.map(async (entry) => {
      const slug = entry.id.split("/").pop();
      const { Content, headings } = await render(entry);
      const h4Headings = headings.filter((h) => h.depth === 4);

      return {
        params: { slug },
        props: {
          slug,
          Content,
          headings: h4Headings,
          frontmatter: entry.data,
        },
      };
    }),
  );

  return pages;
}

const { slug, Content, headings, frontmatter } = Astro.props;
---

<EpLayout frontmatter={frontmatter} slug={`/${slug}`}>
  <div class="mx-auto px-4 py-8 flex flex-col lg:max-w-6xl">
    {/* Back navigation */}
    <a href="/" class="inline-flex items-center gap-1.5 text-sm text-his-text-secondary hover:text-his-green transition-colors w-fit mb-8">
      <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
      </svg>
      <span>{hisMetadata.title}</span>
    </a>

    {/* Episode header */}
    <header class="text-center mb-6">
      <h1 class="text-2xl md:text-3xl font-semibold mb-3">{frontmatter.title}</h1>
      <div class="flex items-center justify-center gap-3 text-sm text-his-text-secondary">
        <time datetime={frontmatter.date.toISOString()}>
          {frontmatter.date.toLocaleDateString("en-US", {
            year: "numeric",
            month: "short",
            day: "numeric",
          })}
        </time>
        {frontmatter.time && (
          <>
            <span class="text-his-text-tertiary">•</span>
            <span>{frontmatter.time} min</span>
          </>
        )}
        {frontmatter.season && (
          <>
            <span class="text-his-text-tertiary">•</span>
            <span class="text-his-green/80">Season {frontmatter.season}</span>
          </>
        )}
      </div>
    </header>

    <Subscribe />
    <TableOfContents headings={headings} />

    <div class="mx-auto max-w-3xl">
      <main>
        <blockquote class="text-sm leading-relaxed text-his-text-secondary max-w-xl mx-auto mb-8">
          {frontmatter.description}
        </blockquote>
        <Content />
      </main>
    </div>
    <Footer />
    <AudioPlayer title={frontmatter.title} src={frontmatter.episodeLink} />
  </div>
</EpLayout>
