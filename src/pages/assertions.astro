---
import HomeContentLayout from "@/layouts/HomeContentLayout.astro";
import { getEpisodeData } from "@/lib/episodes";
import { parseTranscript } from "@/lib/content-extraction";
import { HOME_LAB_CURATION_BY_SLUG } from "@/lib/home-lab-curation";
import { buildBodyMap, nearestTranscriptLine } from "@/lib/home-data";

const { episodes } = await getEpisodeData();

const rawFiles = import.meta.glob<string>(
  "/src/content/podcast/**/*.md",
  { query: "?raw", import: "default", eager: true },
);
const bodyMap = buildBodyMap(rawFiles);

const episodeTranscripts = episodes.map((ep) => ({
  slug: ep.slug,
  episodeTitle: ep.episodeTitle,
  lines: parseTranscript(bodyMap.get(ep.slug) ?? ""),
}));

const vividCards = episodeTranscripts.flatMap((entry) => {
  const curated = HOME_LAB_CURATION_BY_SLUG.get(entry.slug)?.assertion;
  if (!curated) return [];
  const line = nearestTranscriptLine(entry.lines, curated.at);
  if (!line) return [];
  return [{
    slug: entry.slug,
    episodeTitle: entry.episodeTitle,
    speaker: line.speaker,
    text: curated.text ?? line.text,
    seconds: line.seconds,
  }];
});
---

<HomeContentLayout activeLayout="G" title="Assertions" description="Bold declarations from Hope in Source conversations.">
  <section aria-label="Assertions">
    <div id="home-assertions" data-collapsed="true">
      {vividCards.map((card) => (
        <a
          href={`/${card.slug}#t=${card.seconds}`}
          class="assertion-item"
          data-session-key={`${card.slug}:${card.seconds}:${card.speaker}`}
        >
          <p class="assertion-text m-0">{card.text}</p>
          <span class="assertion-source">{card.speaker} &mdash; {card.episodeTitle}</span>
        </a>
      ))}
    </div>
    {vividCards.length > 5 && (
      <button type="button" class="lab-show-more" data-expand="#home-assertions">
        show {vividCards.length - 5} more
      </button>
    )}
  </section>
</HomeContentLayout>
