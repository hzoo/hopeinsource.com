---
import Testimonial from "@/components/Testimonial.astro";
import Footer from "@/components/Footer.astro";
import Subscribe from "@/components/Subscribe.astro";
import { Image } from "astro:assets";
import his_cover from "@/assets/his.jpg";
import { getEpisodeData } from "@/lib/episodes";

const { episodesBySeasons, seasons } = await getEpisodeData();
---

<div class="mx-auto px-3 sm:px-5 py-5 sm:py-7 flex flex-col lg:flex-row lg:max-w-6xl">
    <div class="lg:mr-4 flex-grow-0 flex-shrink-0 basis-[500px]">
        <div class="lg:fixed lg:top-1/2 lg:-translate-y-1/2">
            <div class="flex flex-col items-center text-center max-w-[472px] mx-auto">
                <Image
                    src={his_cover}
                    alt="Hope in Source Cover Art"
                    class="w-full max-w-[472px] h-auto aspect-square object-contain mb-4 sm:max-w-[90%]"
                    loading="eager"
                    format="webp"
                    quality={90}
                />
                <div class="taglines text-center space-y-1">
                    <p class="m-0 text-lg font-medium tracking-wide opacity-0 animate-[fadeIn_0.8s_ease_0.2s_forwards]">
                        off-the-cuff conversations between friends
                    </p>
                    <p class="m-0 text-[0.85rem] text-his-text-secondary italic opacity-0 animate-[fadeIn_0.8s_ease_0.5s_forwards]">
                        finding the sacred in the ordinary
                    </p>
                    <p class="m-0 text-[0.85rem] text-his-text-secondary italic opacity-0 animate-[fadeIn_0.8s_ease_0.7s_forwards]">
                        universal within the particular
                    </p>
                    <p class="m-0 text-[0.85rem] text-his-text-secondary italic opacity-0 animate-[fadeIn_0.8s_ease_0.9s_forwards]">
                        where word becomes flesh
                    </p>
                </div>
                <div class="mt-5 space-y-1.5 text-xs text-his-text-tertiary">
                    <div class="opacity-0 animate-[fadeIn_0.8s_ease_1.1s_forwards]">
                        <Subscribe />
                    </div>
                    <p class="m-0 opacity-0 animate-[fadeIn_0.8s_ease_1.3s_forwards]">
                        with{" "}
                        <a href="https://henryzoo.com/living-out-in-faith">Henry</a>
                        {" "}&{" "}
                        <a href="https://nadia.xyz/public-faith">Nadia</a>
                    </p>
                </div>
            </div>
        </div>
    </div>
    <div class="flex-1">
        <div class="space-y-7 sm:space-y-8">
            {seasons.map((season) => (
                <section>
                    {season !== 0 && (
                        <div class="mb-2.5">
                            <h2 class="text-xl font-semibold tracking-wide text-his-green">
                                {season === 6 ? "Internet Checkpoint" : season === 2 ? "Maintainers Anonymous" : `Season ${season}`}
                            </h2>
                        </div>
                    )}
                    <div class="space-y-0.5">
                        {episodesBySeasons[season].map((episode) => (
                            <article
                                class="episode-card group relative px-3 sm:px-4 py-3.5 rounded-lg border-l-2 border-l-transparent hover:border-l-his-green/60 hover:bg-his-hover/30 transition-all duration-200"
                                title={episode.data.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                            >
                                <a href={`/${episode.slug}`} class="block" data-astro-prefetch="hover">
                                    <h3 class="text-lg font-medium leading-snug group-hover:text-his-green transition-colors min-w-0">
                                        {episode.episodeTitle}
                                        <span class="ml-1 font-mono text-[0.68rem] leading-none text-his-text-tertiary/75 whitespace-nowrap align-middle">
                                            #{episode.epNumber}
                                        </span>
                                    </h3>
                                    <div class="flex flex-wrap items-center gap-x-2 text-sm text-his-text-tertiary mt-0">
                                        {episode.guestDisplays.length > 0 && (
                                            <>
                                                <span class="text-his-text-secondary">
                                                    {episode.guestDisplays.map((g, i) => (
                                                        <>
                                                            {i > 0 && ", "}
                                                            {g.name}{g.count > 1 && <sup class="ml-0.5 text-[0.65em] text-his-green/50 font-normal">×{g.count}</sup>}
                                                        </>
                                                    ))}
                                                </span>
                                                <span class="text-his-text-tertiary/50">·</span>
                                            </>
                                        )}
                                        <span>{episode.data.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</span>
                                        {(episode.data.video?.url || episode.data.time) && (
                                            <>
                                                <span class="text-his-text-tertiary/50">·</span>
                                                <span class="inline-flex items-center gap-1.5">
                                                    {episode.data.video?.url && (
                                                        <span
                                                            class="inline-flex h-3.5 w-3.5 items-center justify-center rounded-full border border-his-green/40 bg-his-green/15 text-his-green"
                                                            title="Video episode"
                                                        >
                                                            <svg class="h-2.5 w-2.5" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                                                                <path d="M8 5v14l11-7z" />
                                                            </svg>
                                                            <span class="sr-only">Video episode</span>
                                                        </span>
                                                    )}
                                                    {episode.data.time && <span>{episode.data.time} min</span>}
                                                </span>
                                            </>
                                        )}
                                    </div>
                                    {(() => {
                                            const desc = episode.data.description;
                                            const match = desc.match(/^([^?]+\?)\s*(.*)$/);
                                            if (match) {
                                              const [, firstSentence, rest] = match;
                                              return (
                                                <>
                                                  <p class="mt-1.5 text-sm text-his-text font-medium leading-relaxed">
                                                    {firstSentence}
                                                  </p>
                                                  {rest && (
                                                    <p class="mt-0.5 text-sm text-his-text-secondary/80 leading-relaxed line-clamp-2 group-hover:text-his-text-secondary transition-colors">
                                                      {rest}
                                                    </p>
                                                  )}
                                                </>
                                              );
                                            }
                                            return (
                                              <p class="mt-1.5 text-sm text-his-text-secondary/80 leading-relaxed line-clamp-2 group-hover:text-his-text-secondary transition-colors">
                                                {desc}
                                              </p>
                                            );
                                          })()}
                                </a>
                            </article>
                        ))}
                    </div>
                </section>
            ))}
        </div>
        <div class="mt-28 rounded-2xl bg-his-hover/15 px-4 sm:px-6 py-2 -mx-2 sm:-mx-3">
            <Testimonial />
        </div>
        <Footer />
    </div>
</div>
