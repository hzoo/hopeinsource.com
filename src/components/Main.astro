---
import Testimonial from "@/components/Testimonial.astro";
import Footer from "@/components/Footer.astro";
import Subscribe from "@/components/Subscribe.astro";
import { Image } from "astro:assets";
import his_cover from "@/assets/his.jpg";
import { getEpisodeData } from "@/lib/episodes";

const { episodesBySeasons, seasons } = await getEpisodeData();
---

<div class="mx-auto px-3 sm:px-5 py-5 sm:py-7 flex flex-col lg:flex-row lg:max-w-6xl">
    <div class="lg:mr-4 flex-grow-0 flex-shrink-0 basis-[500px]">
        <div class="lg:fixed lg:top-1/2 lg:-translate-y-1/2">
            <div class="flex flex-col items-center text-center max-w-[472px] mx-auto">
                <Image
                    src={his_cover}
                    alt="Hope in Source Cover Art"
                    class="w-full max-w-[472px] h-auto aspect-square object-contain mb-4 sm:max-w-[90%]"
                    loading="eager"
                    format="webp"
                    quality={90}
                />
                <div class="taglines text-center space-y-1">
                    <p class="m-0 text-lg font-medium tracking-wide opacity-0 animate-[fadeIn_0.8s_ease_0.2s_forwards]">
                        off-the-cuff conversations between friends
                    </p>
                    <p class="m-0 text-[0.85rem] text-his-text-secondary italic opacity-0 animate-[fadeIn_0.8s_ease_0.5s_forwards]">
                        finding the sacred in the ordinary
                    </p>
                    <p class="m-0 text-[0.85rem] text-his-text-secondary italic opacity-0 animate-[fadeIn_0.8s_ease_0.7s_forwards]">
                        universal within the particular
                    </p>
                    <p class="m-0 text-[0.85rem] text-his-text-secondary italic opacity-0 animate-[fadeIn_0.8s_ease_0.9s_forwards]">
                        where word becomes flesh
                    </p>
                </div>
                <div class="mt-5 space-y-1.5 text-xs text-his-text-tertiary">
                    <div class="opacity-0 animate-[fadeIn_0.8s_ease_1.1s_forwards]">
                        <Subscribe />
                    </div>
                    <p class="m-0 opacity-0 animate-[fadeIn_0.8s_ease_1.3s_forwards]">
                        with{" "}
                        <a href="https://henryzoo.com/living-out-in-faith">Henry</a>
                        {" "}&{" "}
                        <a href="https://nadia.xyz/public-faith">Nadia</a>
                    </p>
                </div>
            </div>
        </div>
    </div>
    <div class="flex-1">
        <div class="space-y-5">
            {seasons.map((season) => (
                <section class="space-y-1">
                    {season !== 0 && (
                        <div class="flex items-center gap-3 mb-2">
                            <h2 class="text-xl font-semibold tracking-wide text-his-green">
                                {season === 2 ? "Maintainers Anonymous" : `Season ${season}`}
                            </h2>
                            <div class="flex-1 h-px bg-gradient-to-r from-his-green/30 to-transparent"></div>
                        </div>
                    )}
                    <div class="space-y-1">
                        {episodesBySeasons[season].map((episode) => (
                            <article class="group relative px-3 sm:px-4 py-1.5 rounded-lg border border-transparent hover:border-his-hr hover:bg-his-hover/50 transition-all duration-200">
                                <a href={`/${episode.slug}`} class="block" data-astro-prefetch="hover">
                                    <h3 class="text-lg font-medium group-hover:text-his-green transition-colors pr-12">
                                        {episode.episodeTitle}
                                    </h3>
                                    <div class="flex flex-wrap items-center gap-x-2 text-sm text-his-text-tertiary mt-0.5">
                                        {episode.guestDisplays.length > 0 && (
                                            <>
                                                <span class="text-his-text-secondary">
                                                    {episode.guestDisplays.map((g, i) => (
                                                        <>
                                                            {i > 0 && ", "}
                                                            {g.name}{g.count > 1 && <sup class="ml-0.5 text-[0.65em] text-his-green/50 font-normal">×{g.count}</sup>}
                                                        </>
                                                    ))}
                                                </span>
                                                <span class="text-his-text-tertiary/50">·</span>
                                            </>
                                        )}
                                        <span>{episode.data.date.toLocaleDateString('en-US', {
                                          year: 'numeric',
                                          month: 'short',
                                          day: 'numeric',
                                        })}</span>
                                        {episode.data.time && (
                                            <>
                                                <span class="text-his-text-tertiary/50">·</span>
                                                <span>{episode.data.time} min</span>
                                            </>
                                        )}
                                    </div>
                                    {(() => {
                                            const desc = episode.data.description;
                                            const match = desc.match(/^([^?]+\?)\s*(.*)$/);
                                            if (match) {
                                              const [, firstSentence, rest] = match;
                                              return (
                                                <>
                                                  <p class="mt-1 text-sm text-his-text font-medium leading-relaxed">
                                                    {firstSentence}
                                                  </p>
                                                  {rest && (
                                                    <p class="mt-0.5 text-sm text-his-text-secondary leading-relaxed line-clamp-2">
                                                      {rest}
                                                    </p>
                                                  )}
                                                </>
                                              );
                                            }
                                            return (
                                              <p class="mt-1 text-sm text-his-text-secondary leading-relaxed line-clamp-2">
                                                {desc}
                                              </p>
                                            );
                                          })()}
                                </a>
                                {/* Episode number badge */}
                                <span class="absolute top-2 right-3 text-xs font-mono text-his-text-tertiary">
                                    {episode.epNumber}
                                </span>
                            </article>
                        ))}
                    </div>
                </section>
            ))}
        </div>
        <hr class="mt-16 mb-24 border-his-hr/30" />
        <Testimonial />
        <Footer />
    </div>
</div>
