---
import Testimonial from "@/components/Testimonial.astro";
import Footer from "@/components/Footer.astro";
import Subscribe from "@/components/Subscribe.astro";
import { Image } from "astro:assets";
import his_cover from "@/assets/his.jpg";
import { getEpisodeData } from "@/lib/episodes";
import { shuffle } from "@/lib/shuffle";
import { HOME_LAYOUTS } from "@/lib/home-layouts";
import {
  deriveTopics,
  extractQuestions,
  timestampToSeconds,
} from "@/lib/content-extraction";

const { episodes } = await getEpisodeData();

const rawFiles = import.meta.glob<string>(
  "/src/content/podcast/**/*.md",
  { query: "?raw", import: "default", eager: true },
);
const bodyMap_ = new Map<string, string>();
for (const [path, content] of Object.entries(rawFiles)) {
  const slug = path.split("/").pop()?.replace(".md", "") ?? "";
  const bodyStart = content.indexOf("---", 3);
  const body = bodyStart >= 0 ? content.slice(bodyStart + 3).trim() : content;
  bodyMap_.set(slug, body);
}

const episodeBodies = episodes.map((ep) => ({
  slug: ep.slug,
  body: bodyMap_.get(ep.slug) ?? "",
  episodeTitle: ep.episodeTitle,
  description: ep.data.description,
}));

const allQuotes = episodes.flatMap((ep) =>
  (ep.data.quotes ?? []).map((q) => ({
    ...q,
    seconds: timestampToSeconds(q.timestamp),
    slug: ep.slug,
    episodeTitle: ep.episodeTitle,
    year: ep.data.date.getFullYear(),
  })),
);

const conversationQuotes = (() => {
  const pool = shuffle([...allQuotes]);
  const result: typeof pool = [];
  let lastSpeaker = "";
  const remaining = [...pool];
  while (remaining.length > 0) {
    const idx = remaining.findIndex((q) => q.speaker !== lastSpeaker);
    if (idx === -1) {
      result.push(...remaining);
      break;
    }
    const [picked] = remaining.splice(idx, 1);
    result.push(picked);
    lastSpeaker = picked.speaker;
  }
  return result;
})();

const bodyMap = new Map(episodeBodies.map(({ slug, body }) => [slug, body]));
const topicClusters = shuffle(deriveTopics(episodes, bodyMap));

const allQuestions = shuffle(
  episodeBodies.flatMap(({ slug, episodeTitle, description }) =>
    extractQuestions(slug, episodeTitle, description),
  ),
);

const epMap = new Map(episodes.map((e) => [e.slug, e]));

function stableHash(value: string): number {
  let hash = 2166136261;
  for (let i = 0; i < value.length; i += 1) {
    hash ^= value.charCodeAt(i);
    hash = Math.imul(hash, 16777619);
  }
  return hash >>> 0;
}

function convoSide(speaker: string, slug: string, seconds: number): "sent" | "received" {
  const seed = stableHash(`${speaker}:${slug}:${seconds}`) / 4294967295;
  if (speaker === "Henry") return seed < 0.82 ? "sent" : "received";
  return seed < 0.72 ? "received" : "sent";
}
---

<div
  id="home-layout-root"
  class="home-root"
  data-active-layout="C"
>
  <section id="home-brand">
    <div class="brand-inner">
      <div class="brand-content flex flex-col items-center text-center max-w-[472px] mx-auto">
        <h1 class="brand-title m-0">Hope in Source</h1>
        <Image
          src={his_cover}
          alt="Hope in Source Cover Art"
          class="brand-cover w-full max-w-[472px] h-auto aspect-square object-contain mb-4 sm:max-w-[90%]"
          loading="eager"
          format="webp"
          quality={90}
        />
        <div class="brand-taglines text-center space-y-1">
          <p class="m-0 text-lg font-medium tracking-wide opacity-0 animate-[fadeIn_0.8s_ease_0.2s_forwards]">
            off-the-cuff conversations between friends
          </p>
          <p class="m-0 text-[0.85rem] text-his-text-secondary italic opacity-0 animate-[fadeIn_0.8s_ease_0.5s_forwards]">
            finding the sacred in the ordinary
          </p>
          <p class="m-0 text-[0.85rem] text-his-text-secondary italic opacity-0 animate-[fadeIn_0.8s_ease_0.7s_forwards]">
            universal within the particular
          </p>
          <p class="m-0 text-[0.85rem] text-his-text-secondary italic opacity-0 animate-[fadeIn_0.8s_ease_0.9s_forwards]">
            where word becomes flesh
          </p>
        </div>
        <div class="brand-meta mt-5 space-y-1.5 text-xs text-his-text-tertiary">
          <div class="opacity-0 animate-[fadeIn_0.8s_ease_1.1s_forwards]">
            <Subscribe />
          </div>
          <p class="m-0 opacity-0 animate-[fadeIn_0.8s_ease_1.3s_forwards]">
            with <a href="https://henryzoo.com/living-out-in-faith">Henry</a> & <a href="https://nadia.xyz/public-faith">Nadia</a>
          </p>
        </div>
      </div>
    </div>
  </section>

  <section id="home-top-controls" aria-label="Homepage controls">
    <div class="home-controls-inner">
      <div class="home-view-list" role="toolbar" aria-label="Switch homepage view">
        {HOME_LAYOUTS.map((layout) => (
          <button
            type="button"
            class="home-view-button"
            data-layout-toggle
            data-layout={layout.id}
            aria-label={layout.label}
            aria-pressed={layout.id === "C" ? "true" : "false"}
            aria-controls={`home-layout-${layout.id}`}
          >
            {layout.label}
          </button>
        ))}
      </div>
      <a href="/episodes" class="convo-more-link" data-astro-prefetch="hover">browse episodes</a>
    </div>
  </section>

  <div id="home-layout-stage">
    <section id="home-layout-C" data-layout-section="C" aria-label="Conversation layout">
      <div id="home-dialogue">
        <div class="convo-flow">
          {conversationQuotes.map((q) => {
            const side = convoSide(q.speaker, q.slug, q.seconds);
            return (
              <div
                class={`convo-line ${side === "sent" ? "convo-sent" : "convo-received"}`}
              >
                <div class="convo-meta">
                  <span class="convo-speaker">{q.speaker}</span>
                  <span class="convo-source">{q.episodeTitle}</span>
                </div>
                <a href={`/${q.slug}#t=${q.seconds}`} class="convo-bubble" data-astro-prefetch="hover">
                  <p class="m-0">{q.text}</p>
                </a>
              </div>
            );
          })}
        </div>
      </div>
    </section>

    <section id="home-layout-G" data-layout-section="G" aria-label="Topics layout">
      <div id="home-topics">
        {topicClusters.map((cluster) => {
          const rep = allQuotes.find((q) => q.topic === cluster.topic);
          return (
            <div class="topic-cluster">
              <h3 class="topic-name">{cluster.topic}</h3>
              {rep && <p class="topic-excerpt">&ldquo;{rep.text}&rdquo;</p>}
              <div class="topic-chips">
                {cluster.episodeSlugs.map((s) => {
                  const ep = epMap.get(s);
                  return ep ? (
                    <a
                      href={`/${s}`}
                      class="topic-chip"
                      data-astro-prefetch="hover"
                    >
                      {ep.episodeTitle}
                    </a>
                  ) : null;
                })}
              </div>
            </div>
          );
        })}
      </div>
    </section>

    <section id="home-layout-I" data-layout-section="I" aria-label="Questions layout">
      <div id="home-questions">
        {allQuestions.map((q) => {
          const wc = q.question.split(/\s+/).length;
          const len = wc <= 8 ? "short" : wc >= 18 ? "long" : "medium";
          return (
            <a
              href={`/${q.slug}`}
              class="question-item"
              data-astro-prefetch="hover"
              data-len={len}
            >
              <p class="question-text m-0">{q.question}</p>
              <span class="question-source">{q.episodeTitle}</span>
            </a>
          );
        })}
      </div>
    </section>
  </div>

  <section id="home-footer">
    <Testimonial />
    <Footer compact />
  </section>
</div>

<script src="../scripts/home-layout-lab.ts"></script>
