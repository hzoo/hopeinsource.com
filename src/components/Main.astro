---
import { getCollection } from "astro:content";
import type { PodcastEntry } from "@/types/podcast";
import Testimonial from "@/components/Testimonial.astro";
import Footer from "@/components/Footer.astro";
import Subscribe from "@/components/Subscribe.astro";
import { Image } from "astro:assets";
import his_cover from "@/assets/his.jpg";

// Move all data processing to build time
const rawPosts = await getCollection("podcast");
const posts: PodcastEntry[] = rawPosts
  .sort((a, b) => {
    const aSeason = a.data.season || 0;
    const bSeason = b.data.season || 0;
    if (bSeason !== aSeason) {
      return bSeason - aSeason;
    }
    return b.data.sidebar.order - a.data.sidebar.order;
  })
  .map(post => ({
    ...post,
    slug: post.id.split('/').pop() || ''
  }));

// Pre-compute episodes by season at build time
const episodesBySeasons = Object.fromEntries(
  Object.entries(
    posts.reduce((acc, episode) => {
      const season = episode.data.season || 0;
      if (!acc[season]) {
        acc[season] = [];
      }
      acc[season].push(episode);
      return acc;
    }, {} as Record<number, PodcastEntry[]>)
  ).sort(([a], [b]) => Number(b) - Number(a))
);

const seasons = Object.keys(episodesBySeasons).map(Number).sort((a, b) => b - a);

// Pre-compute episode numbers (slug -> episode number)
const episodeNumbers = new Map(
  posts.map((post, index) => [post.slug, posts.length - index])
);

---

<div class="mx-auto px-5 py-7 flex flex-col lg:flex-row lg:max-w-6xl">
    <div class="lg:mr-4 flex-grow-0 flex-shrink-0 basis-[500px]">
        <div class="lg:fixed lg:top-1/2 lg:-translate-y-1/2">
            <div class="flex flex-col items-center text-center max-w-[472px] mx-auto">
                <Image
                    src={his_cover}
                    alt="Hope in Source Cover Art"
                    class="w-full max-w-[472px] h-auto aspect-square object-contain mb-4 sm:max-w-[90%]"
                    loading="eager"
                    format="webp"
                    quality={90}
                />
                <div class="taglines text-center space-y-1">
                    <p class="m-0 text-lg font-medium tracking-wide opacity-0 animate-[fadeIn_0.8s_ease_0.2s_forwards]">
                        off-the-cuff conversations between friends
                    </p>
                    <p class="m-0 text-[0.85rem] text-his-text-secondary italic opacity-0 animate-[fadeIn_0.8s_ease_0.5s_forwards]">
                        finding the sacred in the ordinary
                    </p>
                    <p class="m-0 text-[0.85rem] text-his-text-secondary italic opacity-0 animate-[fadeIn_0.8s_ease_0.7s_forwards]">
                        universal within the particular
                    </p>
                    <p class="m-0 text-[0.85rem] text-his-text-secondary italic opacity-0 animate-[fadeIn_0.8s_ease_0.9s_forwards]">
                        where word becomes flesh
                    </p>
                </div>
                <p class="mt-4 m-0 text-xs text-his-text-tertiary opacity-0 animate-[fadeIn_0.8s_ease_1.1s_forwards]">
                    backstory:{" "}
                    <a href="https://henryzoo.com/living-out-in-faith">Henry</a>
                    {" "}·{" "}
                    <a href="https://nadia.xyz/public-faith">Nadia</a>
                </p>
                <Subscribe />
            </div>
        </div>
    </div>
    <div class="flex-1">
        <div class="space-y-8">
            {seasons.map((season) => (
                <section class="space-y-4">
                    {season !== 0 && (
                        <div class="flex items-center gap-3 mb-4">
                            <h2 class="text-xl font-semibold tracking-wide text-his-green">Season {season}</h2>
                            <div class="flex-1 h-px bg-gradient-to-r from-his-green/30 to-transparent"></div>
                        </div>
                    )}
                    <div class="space-y-2">
                        {episodesBySeasons[season].map((episode) => {
                            const epNumber = episodeNumbers.get(episode.slug);
                            return (
                            <article class="group relative px-4 py-3 rounded-xl border border-transparent hover:border-his-hr hover:bg-his-hover/50 transition-all duration-200">
                                <a href={`/${episode.slug}`} class="block">
                                    <h3 class="text-lg font-medium group-hover:text-his-green transition-colors pr-12">
                                        {episode.data.title}
                                    </h3>
                                    <div class="flex items-center gap-2 text-sm text-his-text-secondary mt-1.5">
                                        <span>{episode.data.date.toLocaleDateString('en-US', {
                                          year: 'numeric',
                                          month: 'short',
                                          day: 'numeric',
                                        })}</span>
                                        {episode.data.time && (
                                            <>
                                                <span class="text-his-text-tertiary">•</span>
                                                <span>{episode.data.time} min</span>
                                            </>
                                        )}
                                    </div>
                                    {(() => {
                                            const desc = episode.data.description;
                                            const match = desc.match(/^([^?]+\?)\s*(.*)$/);
                                            if (match) {
                                              const [, firstSentence, rest] = match;
                                              return (
                                                <>
                                                  <p class="mt-2 text-sm text-his-text font-medium leading-relaxed">
                                                    {firstSentence}
                                                  </p>
                                                  {rest && (
                                                    <p class="mt-1 text-sm text-his-text-secondary leading-relaxed line-clamp-3">
                                                      {rest}
                                                    </p>
                                                  )}
                                                </>
                                              );
                                            }
                                            return (
                                              <p class="mt-2 text-sm text-his-text-secondary leading-relaxed line-clamp-3">
                                                {desc}
                                              </p>
                                            );
                                          })()}
                                </a>
                                {/* Episode number badge */}
                                <span class="absolute top-4 right-4 text-xs font-mono text-his-text-tertiary bg-his-hover/50 px-2 py-0.5 rounded-full">
                                    {epNumber}
                                </span>
                            </article>
                            );
                        })}
                    </div>
                </section>
            ))}
        </div>
        <hr class="my-8 border-his-hr" />
        <Testimonial />
        <Footer />
    </div>
</div>
