---
import { getCollection } from "astro:content";
import type { PodcastEntry } from "@/types/podcast";
import Testimonial from "@/components/Testimonial";
import Footer from "@/components/Footer";
import Subscribe from "@/components/Subscribe";
import EpisodeList from "@/components/EpisodeList";
import { Image } from "astro:assets";
import his_cover from "@/assets/his.jpg";

const rawPosts = await getCollection("podcast", () => true);
const posts: PodcastEntry[] = rawPosts
  .sort((a, b) => {
    const aSeason = a.data.season || 0;
    const bSeason = b.data.season || 0;
    if (bSeason !== aSeason) {
      return bSeason - aSeason;
    }
    return b.data.sidebar.order - a.data.sidebar.order;
  })
  .map(post => ({
    ...post,
    slug: post.id.split('/').pop() || ''
  }));

// Pre-compute episode grouping by season
const episodesBySeasons = posts.reduce((acc, episode) => {
  const season = episode.data.season || 0;
  if (!acc[season]) {
    acc[season] = [];
  }
  acc[season].push(episode);
  return acc;
}, {} as Record<number, PodcastEntry[]>);

// Sort seasons in descending order
const seasons = Object.keys(episodesBySeasons)
  .map(Number)
  .sort((a, b) => b - a);

const initialSeason = seasons[0];
---

<div class="wrapper mx-auto px-5 py-7 flex flex-col lg:flex-row lg:max-w-6xl">
    <div class="lg:mr-4 flex-grow-0 flex-shrink-0 basis-[500px]">
        <div class="lg:fixed lg:top-1/2 lg:-translate-y-1/2">
            <div class="flex flex-col items-center text-center max-w-[472px] mx-auto">
                <Image
                    src={his_cover}
                    alt="Hope in Source Cover Art"
                    class="w-full max-w-[472px] h-auto aspect-square object-contain mb-4 sm:max-w-[90%]"
                    loading="eager"
                    format="webp"
                    quality={90}
                />
                <p class="m-0 max-w-[75%]">
                    Join <a href="https://twitter.com/left_pad">Henry Zhu</a> for
                    an off-the-cuff conversation between friends.
                </p>
                <p class="mt-0 text-[0.9rem]">
                    (read the backstory from{" "}
                    <a href="https://henryzoo.com/living-out-in-faith">Henry</a>
                    and{" "}
                    <a href="https://nadia.xyz/public-faith">Nadia</a>)
                </p>
                <Subscribe />
            </div>
        </div>
    </div>
    <div class="flex-1">
        <EpisodeList 
            episodesBySeasons={episodesBySeasons} 
            seasons={seasons}
            initialSeason={initialSeason}
            client:load 
        />
        <hr class="my-8 border-his-hr" />
        <Testimonial />
        <Footer />
    </div>
</div>
