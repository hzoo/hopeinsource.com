---
import { getEpisodeData } from "@/lib/episodes";
import Search from "./Search.astro";

interface Props {
  currentSlug: string;
}

const { currentSlug } = Astro.props;
const { episodesBySeasons, seasons } = await getEpisodeData();
---

<!-- Mobile backdrop -->
<div
  id="sidebar-backdrop"
  class="lg:hidden fixed inset-0 bg-black/50 z-30 opacity-0 invisible transition-opacity duration-300"
></div>

<!-- Sidebar -->
<aside
  id="episode-sidebar"
  class="fixed left-0 top-0 h-full w-[280px] sm:w-80 max-w-[calc(100vw-3rem)] bg-his-bg border-r border-his-hr z-40
         transform -translate-x-full lg:translate-x-0 transition-transform duration-300
         flex flex-col"
>
  <!-- Sidebar header with search and mobile close -->
  <div class="px-3 py-3 border-b border-his-hr flex-shrink-0 flex items-center gap-2">
    <div class="flex-1">
      <Search />
    </div>
    <button
      id="sidebar-close"
      class="lg:hidden w-9 h-9 flex items-center justify-center rounded-lg hover:bg-his-hover text-his-text-tertiary transition-colors"
      aria-label="Close sidebar"
    >
      <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
  </div>

  <!-- Scrollable content (hidden scrollbar) -->
  <div class="overflow-y-auto flex-1 p-3 [&::-webkit-scrollbar]:hidden [-ms-overflow-style:none] [scrollbar-width:none]">
    <!-- Episodes list -->
    {seasons.map((season) => (
      <section class="mb-6">
        {season !== 0 && (
          <h3 class="text-[10px] font-bold text-his-green uppercase tracking-[0.2em] mb-3 px-3 flex items-center gap-2">
            <span>{season === 6 ? "Internet Checkpoint" : season === 2 ? "Maintainers Anonymous" : `Season ${season}`}</span>
            <span class="flex-1 h-px bg-gradient-to-r from-his-green/30 to-transparent"></span>
          </h3>
        )}
        <div class="space-y-0.5">
          {episodesBySeasons[season].map((episode) => {
            const isActive = episode.slug === currentSlug;
            return (
              <a
                href={`/${episode.slug}`}
                class:list={[
                  "episode-link group relative block py-2.5 px-3 rounded-lg transition-all duration-200",
                  isActive
                    ? "bg-his-green/12 ring-1 ring-his-green/25"
                    : "hover:bg-his-hover/60"
                ]}
                data-astro-prefetch="hover"
                aria-current={isActive ? "page" : undefined}
              >
                <div class="flex items-start gap-2.5">
                  <span class:list={[
                    "flex-shrink-0 text-[10px] font-mono tabular-nums pt-0.5 transition-colors",
                    isActive ? "text-his-green" : "text-his-text-tertiary group-hover:text-his-text-secondary"
                  ]}>
                    {episode.epNumber}
                  </span>
                  <div class="flex-1 min-w-0">
                    <div class="flex items-baseline justify-between gap-2">
                      <span class:list={[
                        "text-sm leading-snug transition-colors truncate",
                        isActive ? "text-his-green font-medium" : "text-his-text-secondary group-hover:text-his-text"
                      ]}>
                        {episode.episodeTitle}
                      </span>
                      <span class="flex-shrink-0 text-[10px] font-mono tabular-nums text-his-text-tertiary whitespace-nowrap">
                        {episode.data.date.getFullYear() === new Date().getFullYear()
                          ? episode.data.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
                          : `${episode.data.date.toLocaleDateString('en-US', { month: 'short' })} '${String(episode.data.date.getFullYear()).slice(-2)}`}
                      </span>
                    </div>
                    {episode.guestDisplays.length > 0 && (
                      <span class:list={[
                        "block text-xs mt-0.5 transition-colors truncate",
                        isActive ? "text-his-green/70" : "text-his-text-tertiary group-hover:text-his-text-secondary"
                      ]}>
                        {episode.guestDisplays.map((g, i) => (
                            <>
                              {i > 0 && ", "}
                              {g.name}{g.count > 1 && <sup class="ml-0.5 text-[0.65em] text-his-green/50 font-normal">Ã—{g.count}</sup>}
                            </>
                          ))}
                      </span>
                    )}
                  </div>
                </div>
              </a>
            );
          })}
        </div>
      </section>
    ))}
  </div>
</aside>

<script src="../scripts/sidebar.ts"></script>
