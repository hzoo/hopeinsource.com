---
import { getEpisodeData } from "@/lib/episodes";
import Search from "./Search.astro";

interface Props {
  currentSlug: string;
}

const { currentSlug } = Astro.props;
const { episodesBySeasons, seasons } = await getEpisodeData();
---

<!-- Mobile backdrop -->
<div
  id="sidebar-backdrop"
  class="lg:hidden fixed inset-0 bg-black/50 z-30 opacity-0 invisible transition-opacity duration-300"
></div>

<!-- Sidebar -->
<aside
  id="episode-sidebar"
  class="fixed left-0 top-0 h-full w-80 bg-his-bg border-r border-his-hr z-40
         transform -translate-x-full lg:translate-x-0 transition-transform duration-300
         flex flex-col"
>
  <!-- Sidebar header with search -->
  <div class="px-3 py-3 border-b border-his-hr flex-shrink-0">
    <Search />
  </div>

  <!-- Scrollable content (hidden scrollbar) -->
  <div class="overflow-y-auto flex-1 p-3 [&::-webkit-scrollbar]:hidden [-ms-overflow-style:none] [scrollbar-width:none]">
    <!-- Episodes list -->
    {seasons.map((season) => (
      <section class="mb-6">
        {season !== 0 && (
          <h3 class="text-[10px] font-bold text-his-green uppercase tracking-[0.2em] mb-3 px-3 flex items-center gap-2">
            <span>{season === 2 ? "Maintainers Anonymous" : `Season ${season}`}</span>
            <span class="flex-1 h-px bg-gradient-to-r from-his-green/30 to-transparent"></span>
          </h3>
        )}
        <div class="space-y-0.5">
          {episodesBySeasons[season].map((episode) => {
            const isActive = episode.slug === currentSlug;
            return (
              <a
                href={`/${episode.slug}`}
                class:list={[
                  "episode-link group relative block py-2.5 px-3 rounded-lg transition-all duration-200",
                  isActive
                    ? "bg-his-green/12 ring-1 ring-his-green/25"
                    : "hover:bg-his-hover/60"
                ]}
                data-astro-prefetch="hover"
                aria-current={isActive ? "page" : undefined}
              >
                <div class="flex items-start gap-2.5">
                  <span class:list={[
                    "flex-shrink-0 text-[10px] font-mono tabular-nums pt-0.5 transition-colors",
                    isActive ? "text-his-green" : "text-his-text-tertiary group-hover:text-his-text-secondary"
                  ]}>
                    {episode.epNumber}
                  </span>
                  <div class="flex-1 min-w-0">
                    <div class="flex items-baseline justify-between gap-2">
                      <span class:list={[
                        "text-sm leading-snug transition-colors truncate",
                        isActive ? "text-his-green font-medium" : "text-his-text-secondary group-hover:text-his-text"
                      ]}>
                        {episode.episodeTitle}
                      </span>
                      <span class="flex-shrink-0 text-[10px] font-mono tabular-nums text-his-text-tertiary whitespace-nowrap">
                        {episode.data.date.getFullYear() === new Date().getFullYear()
                          ? episode.data.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
                          : `${episode.data.date.toLocaleDateString('en-US', { month: 'short' })} '${String(episode.data.date.getFullYear()).slice(-2)}`}
                      </span>
                    </div>
                    {episode.guestDisplays.length > 0 && (
                      <span class:list={[
                        "block text-xs mt-0.5 transition-colors truncate",
                        isActive ? "text-his-green/70" : "text-his-text-tertiary group-hover:text-his-text-secondary"
                      ]}>
                        {episode.guestDisplays.map((g, i) => (
                            <>
                              {i > 0 && ", "}
                              {g.name}{g.count > 1 && <sup class="ml-0.5 text-[0.65em] text-his-green/50 font-normal">Ã—{g.count}</sup>}
                            </>
                          ))}
                      </span>
                    )}
                  </div>
                </div>
              </a>
            );
          })}
        </div>
      </section>
    ))}
  </div>
</aside>

<script>
  function initSidebar() {
    const sidebar = document.getElementById('episode-sidebar');
    const toggle = document.getElementById('header-sidebar-toggle');
    const backdrop = document.getElementById('sidebar-backdrop');

    function openSidebar() {
      sidebar?.classList.remove('-translate-x-full');
      backdrop?.classList.remove('opacity-0', 'invisible');
      backdrop?.classList.add('opacity-100');
      document.body.style.overflow = 'hidden';
    }

    function closeSidebar() {
      sidebar?.classList.add('-translate-x-full');
      backdrop?.classList.add('opacity-0', 'invisible');
      backdrop?.classList.remove('opacity-100');
      document.body.style.overflow = '';
    }

    // Event listeners
    toggle?.addEventListener('click', () => {
      sidebar?.classList.contains('-translate-x-full') ? openSidebar() : closeSidebar();
    });
    backdrop?.addEventListener('click', closeSidebar);

    // Close on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeSidebar();
    });

    // Swipe gesture for mobile drawer
    let touchStartX = 0;
    let touchStartY = 0;

    document.addEventListener('touchstart', (e) => {
      touchStartX = e.touches[0].clientX;
      touchStartY = e.touches[0].clientY;
    }, { passive: true });

    document.addEventListener('touchend', (e) => {
      const touchEndX = e.changedTouches[0].clientX;
      const touchEndY = e.changedTouches[0].clientY;
      const diffX = touchEndX - touchStartX;
      const diffY = Math.abs(touchEndY - touchStartY);

      // Only trigger if horizontal swipe is dominant
      if (diffY < 100) {
        // Swipe right from left edge to open
        if (touchStartX < 30 && diffX > 80) {
          openSidebar();
        }
        // Swipe left to close
        else if (diffX < -80 && !sidebar?.classList.contains('-translate-x-full')) {
          closeSidebar();
        }
      }
    }, { passive: true });

    // Scroll to active episode
    const activeLink = sidebar?.querySelector('[aria-current="page"]');
    if (activeLink) {
      activeLink.scrollIntoView({ block: 'center', behavior: 'instant' });
    }
  }

  // Initialize on first load
  initSidebar();

  // Re-initialize after View Transitions and close sidebar
  document.addEventListener('astro:after-swap', () => {
    initSidebar();
    // Close mobile sidebar on navigation
    const sidebar = document.getElementById('episode-sidebar');
    const backdrop = document.getElementById('sidebar-backdrop');
    sidebar?.classList.add('-translate-x-full');
    backdrop?.classList.add('opacity-0', 'invisible');
    backdrop?.classList.remove('opacity-100');
    document.body.style.overflow = '';
  });
</script>
