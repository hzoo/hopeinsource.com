---
import type { ExtractedLink } from "@/plugins/remark-links-extractor";

interface TOCHeading {
  slug: string;
  text: string;
}

interface Props {
  headings: TOCHeading[];
  extractedLinks?: ExtractedLink[];
}

const { headings, extractedLinks = [] } = Astro.props;
const hasContent = headings.length > 0 || extractedLinks.length > 0;
---

{hasContent && (
  <>
    <!-- Scrubber (tablet+, right side) -->
    <div
      id="toc-scrubber"
      class="hidden md:flex fixed right-3 top-1/2 -translate-y-1/2 flex-col items-end gap-1.5 p-2 z-40"
      aria-label="Table of contents"
    >
      {/* Section bars */}
      {headings.length > 0 && (
        <button
          id="toc-bars"
          type="button"
          class="flex flex-col items-end gap-1.5 cursor-pointer group rounded-md p-0 bg-transparent border-0 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-his-green/60"
          aria-label="Toggle table of contents"
          aria-controls="toc-nav"
          aria-expanded="false"
        >
          {headings.map((heading) => (
            <span
              class="toc-scrubber-bar w-4 h-1 bg-his-text-tertiary transition-all duration-300 rounded-full group-hover:bg-his-text-secondary"
              data-scrubber-id={heading.slug}
              aria-hidden="true"
            />
          ))}
        </button>
      )}
      {/* Reference count badge - vertical layout */}
      {extractedLinks.length > 0 && (
        <button
          id="ref-badge"
          type="button"
          class="mt-3 flex flex-col items-center gap-0.5 text-[10px] text-his-text-tertiary hover:text-his-green transition-colors cursor-pointer rounded-md p-0 bg-transparent border-0 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-his-green/60"
          aria-label="Toggle references"
          aria-controls="ref-popover"
          aria-expanded="false"
        >
          <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
          </svg>
          <span class="font-medium">{extractedLinks.length}</span>
        </button>
      )}
    </div>

    <!-- TOC popover (sections) -->
    {headings.length > 0 && (
      <nav
        id="toc-nav"
        class="hidden md:block fixed right-12 top-1/2 w-64 max-h-[70vh] bg-his-bg border border-his-hr rounded-lg shadow-xl opacity-0 invisible transition-all duration-200 z-50"
        style="transform: translateY(-50%) translateX(10px);"
      >
        <ul class="list-none p-2 space-y-0.5 overflow-y-auto max-h-[70vh] [&::-webkit-scrollbar]:hidden [-ms-overflow-style:none] [scrollbar-width:none]">
          {headings.map((heading) => (
            <li>
              <a
                href={`#${heading.slug}`}
                class="toc-link block rounded-md text-sm no-underline transition-all duration-200 hover:bg-his-hover py-2 px-2.5 text-his-text-secondary hover:text-his-text font-medium"
                data-heading-id={heading.slug}
              >
                {heading.text}
              </a>
            </li>
          ))}
        </ul>
      </nav>
    )}

    <!-- References popover -->
    {extractedLinks.length > 0 && (
      <div
        id="ref-popover"
        class="hidden md:block fixed right-12 top-[calc(50%+80px)] w-72 max-h-[60vh] overflow-hidden bg-his-bg border border-his-hr rounded-lg shadow-xl opacity-0 invisible transition-all duration-200 z-50"
        style="transform: translateY(-50%) translateX(10px);"
      >
        <div class="p-1.5 overflow-y-auto max-h-full [&::-webkit-scrollbar]:hidden [-ms-overflow-style:none] [scrollbar-width:none]">
          {extractedLinks.map((link) => (
            <div
              class="ref-popover-item py-2 px-2 rounded-md hover:bg-his-hover/50 cursor-pointer transition-colors"
              data-ref-id={`ref-${link.blockquoteIndex}`}
            >
              {link.quoteText && (
                <p class="text-sm text-his-text-secondary leading-relaxed mb-1 line-clamp-2">
                  {link.quoteText.slice(0, 120)}{link.quoteText.length > 120 ? '...' : ''}
                </p>
              )}
              <a
                href={link.url}
                target="_blank"
                rel="noopener noreferrer"
                class="inline-flex items-center gap-1 text-xs text-his-green hover:underline"
                onclick="arguments[0].stopPropagation();"
              >
                <svg class="w-3 h-3 flex-shrink-0 opacity-60" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                </svg>
                <span>{link.text}</span>
              </a>
            </div>
          ))}
        </div>
      </div>
    )}
  </>
)}

<script>
  let currentActiveId: string | null = null;
  let tocOpen = false;
  let refOpen = false;
  let observer: IntersectionObserver | null = null;
  let tocAbort: AbortController | null = null;
  let tocBootstrapAbort: AbortController | null = null;
  let tocInitialized = false;

  function handleTOCClick(e: MouseEvent) {
    const target = e.target as HTMLElement;
    const tocNav = document.getElementById('toc-nav');
    const tocBars = document.getElementById('toc-bars');
    const refPopover = document.getElementById('ref-popover');
    const refBadge = document.getElementById('ref-badge');

    if (tocOpen && !tocNav?.contains(target) && !tocBars?.contains(target)) {
      closeTOC();
    }
    if (refOpen && !refPopover?.contains(target) && !refBadge?.contains(target)) {
      closeRefPopover();
    }
  }

  function handleTOCKeyDown(e: KeyboardEvent) {
    if (e.key === 'Escape') {
      closeTOC();
      closeRefPopover();
    }
  }

  function closeTOC() {
    const tocNav = document.getElementById('toc-nav');
    const tocBars = document.getElementById('toc-bars');
    tocNav?.classList.remove('opacity-100');
    tocNav?.classList.add('invisible', 'opacity-0');
    tocNav?.style.setProperty('transform', 'translateY(-50%) translateX(10px)');
    tocBars?.setAttribute('aria-expanded', 'false');
    tocOpen = false;
  }

  function closeRefPopover() {
    const refPopover = document.getElementById('ref-popover');
    const refBadge = document.getElementById('ref-badge');
    refPopover?.classList.remove('opacity-100');
    refPopover?.classList.add('invisible', 'opacity-0');
    refPopover?.style.setProperty('transform', 'translateY(-50%) translateX(10px)');
    refBadge?.setAttribute('aria-expanded', 'false');
    refOpen = false;
  }

  function initTOC() {
    tocInitialized = true;
    tocAbort?.abort();
    tocAbort = new AbortController();
    const { signal } = tocAbort;

    const tocBars = document.getElementById('toc-bars');
    const tocNav = document.getElementById('toc-nav');
    const tocLinks = document.querySelectorAll('.toc-link');
    const scrubberBars = document.querySelectorAll('.toc-scrubber-bar');

    const refBadge = document.getElementById('ref-badge');
    const refPopover = document.getElementById('ref-popover');
    const refPopoverItems = document.querySelectorAll('.ref-popover-item');

    // Add IDs to blockquotes
    document.querySelectorAll('main blockquote').forEach((bq, index) => {
      bq.id = `ref-${index}`;
      bq.classList.add('reference-block');
    });

    function setActive(id: string) {
      if (currentActiveId === id) return;
      currentActiveId = id;

      tocLinks.forEach(link => {
        const linkId = link.getAttribute('data-heading-id');
        link.classList.toggle('active', linkId === id);
        link.classList.toggle('text-his-green', linkId === id);
      });

      scrubberBars.forEach(bar => {
        const barId = bar.getAttribute('data-scrubber-id');
        const isActive = barId === id;
        bar.classList.toggle('bg-his-green', isActive);
        bar.classList.toggle('w-6', isActive);
        bar.classList.toggle('bg-his-text-tertiary', !isActive);
      });
    }

    function openTOC() {
      closeRefPopover();
      tocNav?.classList.remove('invisible', 'opacity-0');
      tocNav?.classList.add('opacity-100');
      tocNav?.style.setProperty('transform', 'translateY(-50%) translateX(0)');
      tocBars?.setAttribute('aria-expanded', 'true');
      tocOpen = true;
    }

    function openRefPopover() {
      closeTOC();
      refPopover?.classList.remove('invisible', 'opacity-0');
      refPopover?.classList.add('opacity-100');
      refPopover?.style.setProperty('transform', 'translateY(-50%) translateX(0)');
      refBadge?.setAttribute('aria-expanded', 'true');
      refOpen = true;
    }

    // Toggle TOC
    tocBars?.addEventListener('click', (e) => {
      e.stopPropagation();
      tocOpen ? closeTOC() : openTOC();
    }, { signal });

    // Toggle refs
    refBadge?.addEventListener('click', (e) => {
      e.stopPropagation();
      refOpen ? closeRefPopover() : openRefPopover();
    }, { signal });

    // TOC links - scroll to section
    tocLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const href = link.getAttribute('href');
        if (href) {
          const target = document.querySelector(href);
          if (target) {
            closeTOC();
            setTimeout(() => target.scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
          }
        }
      }, { signal });
    });

    // Ref items - scroll to blockquote
    refPopoverItems.forEach(item => {
      item.addEventListener('click', (e) => {
        const target = e.target as HTMLElement;
        if (target.tagName === 'A') return;
        const refId = item.getAttribute('data-ref-id');
        if (refId) {
          const bq = document.getElementById(refId);
          if (bq) {
            bq.scrollIntoView({ behavior: 'smooth', block: 'start' });
            bq.classList.add('ref-highlight');
            setTimeout(() => bq.classList.remove('ref-highlight'), 1500);
          }
        }
      }, { signal });
    });

    // Intersection Observer
    observer = new IntersectionObserver(
      (entries) => entries.forEach((entry) => {
        if (entry.isIntersecting) setActive(entry.target.id);
      }),
      { rootMargin: '-10% 0px -70% 0px', threshold: 0 }
    );
    document.querySelectorAll('h4').forEach((h) => observer?.observe(h));

    // Global listeners
    document.addEventListener('click', handleTOCClick, { signal });
    document.addEventListener('keydown', handleTOCKeyDown, { signal });

    // Init from hash
    const hash = window.location.hash;
    if (hash) setActive(hash.replace('#', ''));
  }

  function initTOCLazyBootstrap() {
    tocBootstrapAbort?.abort();
    tocBootstrapAbort = new AbortController();
    const { signal } = tocBootstrapAbort;

    const tocBars = document.getElementById('toc-bars');
    const refBadge = document.getElementById('ref-badge');
    const scrollContainer = document.getElementById('episode-scroll-container');

    const warmInit = () => {
      if (tocInitialized) return;
      initTOC();
    };

    const handleFirstControlClick = (e: Event) => {
      const control = e.currentTarget as HTMLElement | null;
      if (!control) return;
      e.preventDefault();
      e.stopImmediatePropagation();
      warmInit();
      queueMicrotask(() => control.click());
    };

    tocBars?.addEventListener('click', handleFirstControlClick, { signal, capture: true, once: true });
    refBadge?.addEventListener('click', handleFirstControlClick, { signal, capture: true, once: true });
    scrollContainer?.addEventListener('scroll', warmInit, { signal, passive: true, once: true });
    if (!scrollContainer) {
      window.addEventListener('scroll', warmInit, { signal, passive: true, once: true });
    }
  }

  function cleanupTOC() {
    tocAbort?.abort();
    tocAbort = null;
    tocBootstrapAbort?.abort();
    tocBootstrapAbort = null;

    if (observer) {
      observer.disconnect();
      observer = null;
    }
    tocOpen = false;
    refOpen = false;
    currentActiveId = null;
    tocInitialized = false;
  }

  function setupTOC() {
    cleanupTOC();
    initTOCLazyBootstrap();
  }

  document.addEventListener('astro:page-load', setupTOC);

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupTOC, { once: true });
  } else {
    setupTOC();
  }
</script>
